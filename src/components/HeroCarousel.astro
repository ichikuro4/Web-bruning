---
interface Slide {
  title: string;
  subtitle: string;
  description: string;
  image?: string;
  video?: string;
  duration?: number;
  cta?: {
    text: string;
    link: string;
  };
}

interface Props {
  slides: Slide[];
  autoplayInterval?: number;
}

const { slides, autoplayInterval = 5000 } = Astro.props;
const slideDurations = slides.map(s => s.duration ?? autoplayInterval);
---

<div class="hero-carousel relative w-full min-h-[calc(100vh-80px)] pt-20 overflow-hidden bg-slate-900">
  <!-- Slides Container -->
  <div class="slides-wrapper relative w-full min-h-screen">
    {slides.map((slide, index) => (
      <div 
        class={`slide absolute inset-0 min-h-[calc(100vh-80px)] transition-opacity duration-1000 ${index === 0 ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
        data-slide={index}
      >
        <!-- Background Image or Video with Overlay -->
        <div class="absolute inset-0">
          {slide.video ? (
            <video 
              src={slide.video}
              class="w-full h-full object-cover object-center"
              autoplay
              muted
              loop
              playsinline
              preload="metadata"
              data-slide-video={index}
            />
          ) : (
            <img 
              src={slide.image} 
              alt={slide.title}
              class="w-full h-full object-cover object-right"
              loading={index === 0 ? 'eager' : 'lazy'}
            />
          )}
        </div>

        <!-- Content -->
        {!slide.video && (
          <div class="relative z-20 flex items-center min-h-screen px-4">
          <div class="container mx-auto max-w-7xl">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
              <!-- Columna Izquierda: Texto -->
              <div class="text-left max-w-2xl">
                <h1 class="text-4xl md:text-6xl lg:text-7xl font-black mb-6 text-white drop-shadow-2xl animate-slide-up">
                  <Fragment set:html={slide.title} />
                </h1>
                
                <p class="text-lg md:text-xl mb-10 font-light text-blue-100 animate-slide-up-delay leading-relaxed">
                  {slide.description}
                </p>
                
                {slide.cta && (
                  <div class="flex flex-col sm:flex-row gap-4 animate-slide-up-delay-2">
                    <a 
                      href={slide.cta.link} 
                      class="group bg-gradient-to-r from-colegio-yellow to-yellow-400 hover:from-yellow-400 hover:to-colegio-yellow text-colegio-blue font-bold py-4 px-10 rounded-full transition-all duration-300 hover:scale-110 hover:shadow-2xl shadow-xl flex items-center justify-center gap-2"
                    >
                      <span>{slide.cta.text}</span>
                      <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                      </svg>
                    </a>
                    
                  </div>
                )}
              </div>
              
              <!-- Columna Derecha: Espacio para imagen (se mostrará la imagen de fondo) -->
              <div class="hidden lg:block">
                <!-- Este espacio queda libre, la imagen de fondo se mostrará aquí -->
              </div>
            </div>
          </div>
        </div>
        )}
      </div>
    ))}
  </div>

  <!-- Navigation Arrows -->
  <button 
    class="carousel-btn prev absolute left-4 md:left-8 top-1/2 -translate-y-1/2 z-30 bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/20 rounded-full p-3 md:p-4 transition-all duration-300 hover:scale-110 group"
    aria-label="Anterior"
  >
    <svg class="w-6 h-6 text-white group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
  </button>

  <button 
    class="carousel-btn next absolute right-4 md:right-8 top-1/2 -translate-y-1/2 z-30 bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/20 rounded-full p-3 md:p-4 transition-all duration-300 hover:scale-110 group"
    aria-label="Siguiente"
  >
    <svg class="w-6 h-6 text-white group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
  </button>

  <!-- Indicators -->
  <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-30 flex gap-3">
    {slides.map((_, index) => (
      <button
        class={`indicator w-3 h-3 rounded-full transition-all duration-300 ${index === 0 ? 'bg-colegio-yellow w-8' : 'bg-white/40 hover:bg-white/60'}`}
        data-index={index}
        aria-label={`Ir al slide ${index + 1}`}
      ></button>
    ))}
  </div>

  <!-- Scroll Indicator -->
  <div class="absolute bottom-20 left-1/2 -translate-x-1/2 z-30 animate-bounce">
    <svg class="w-6 h-6 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
    </svg>
  </div>
</div>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-fade-in { animation: fadeIn 1s ease-out; }
  .animate-slide-up { animation: slideUp 0.8s ease-out; }
  .animate-slide-up-delay { animation: slideUp 0.8s ease-out 0.2s backwards; }
  .animate-slide-up-delay-2 { animation: slideUp 0.8s ease-out 0.4s backwards; }

  .carousel-btn {
    opacity: 0;
    transition: opacity 0.3s;
  }

  .hero-carousel:hover .carousel-btn {
    opacity: 1;
  }
</style>

<script define:vars={{ autoplayInterval, slideDurations }}>
  let currentSlide = 0;
  let autoplayTimer = null;
  let isPaused = false;
  let pauseTimer = null;

  const slideEls = document.querySelectorAll('.slide');
  const indicators = document.querySelectorAll('.indicator');
  const prevBtn = document.querySelector('.carousel-btn.prev');
  const nextBtn = document.querySelector('.carousel-btn.next');

  function getSlideDuration(index) {
    return slideDurations[index] ?? autoplayInterval;
  }

  function showSlide(index) {
    slideEls.forEach((slide, i) => {
      if (i === index) {
        slide.classList.add('opacity-100', 'z-10');
        slide.classList.remove('opacity-0', 'z-0');
        const video = slide.querySelector('video');
        if (video) {
          video.currentTime = 0;
          video.play().catch(() => {});
        }
      } else {
        slide.classList.remove('opacity-100', 'z-10');
        slide.classList.add('opacity-0', 'z-0');
        const video = slide.querySelector('video');
        if (video) video.pause();
      }
    });

    indicators.forEach((indicator, i) => {
      if (i === index) {
        indicator.classList.add('bg-colegio-yellow', 'w-8');
        indicator.classList.remove('bg-white/40', 'w-3');
      } else {
        indicator.classList.remove('bg-colegio-yellow', 'w-8');
        indicator.classList.add('bg-white/40', 'w-3');
      }
    });

    currentSlide = index;
  }

  function nextSlide() {
    showSlide((currentSlide + 1) % slideEls.length);
  }

  function prevSlide() {
    showSlide((currentSlide - 1 + slideEls.length) % slideEls.length);
  }

  function stopAutoplay() {
    if (autoplayTimer) { clearTimeout(autoplayTimer); autoplayTimer = null; }
  }

  function scheduleNext() {
    stopAutoplay();
    if (!isPaused) {
      const duration = getSlideDuration(currentSlide);
      autoplayTimer = setTimeout(() => {
        nextSlide();
        scheduleNext();
      }, duration);
    }
  }

  function pauseTemporarily(ms = 10000) {
    isPaused = true;
    stopAutoplay();
    if (pauseTimer) clearTimeout(pauseTimer);
    pauseTimer = setTimeout(() => {
      isPaused = false;
      scheduleNext();
      pauseTimer = null;
    }, ms);
  }

  prevBtn?.addEventListener('click', () => { prevSlide(); pauseTemporarily(); });
  nextBtn?.addEventListener('click', () => { nextSlide(); pauseTemporarily(); });

  indicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => { showSlide(index); pauseTemporarily(); });
  });

  scheduleNext();

  window.addEventListener('beforeunload', () => {
    stopAutoplay();
    if (pauseTimer) clearTimeout(pauseTimer);
  });
</script>
